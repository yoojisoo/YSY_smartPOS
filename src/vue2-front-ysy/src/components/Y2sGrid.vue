
<!-- create by clubbboy@naver.com 2022 07 18
	** Y2sGrid props Íµ¨Ï°∞ Î∞è ÏÇ¨Ïö©Î≤ï **
	< vuetify Í∏∞Î∞ò gridÎ•º CustomizingÌïòÏó¨ ÏÇ¨Ïö©>

	props -> gridDataList        : array(json data) - body data Ï†ïÏùò
		  -> gridInfo            : Ìï¥Îãπ Î™®ÎìàÏùÑ ÏÇ¨Ïö©ÌïòÎäî ÌéòÏù¥ÏßÄÏóêÏÑú "props"Ïù¥Î¶ÑÏùÑ "gridInfo"Î°ú ÎÑòÍ≤®Ï§å.
	     
		  üîÖ ÏÜçÏÑ±
	      -> gridInfo.headers             : array(json data) - header Ïª¨Îüº Ï†ïÏùò
		  -> gridInfo.page.sync           : int  - ÌéòÏù¥ÏßÄ ÎÑ§Ïù¥ÏÖòÍ≥ºÏùò Ïã±ÌÅ¨(ÎÇòÌÉÄÎÇòÎäî ÏµúÏ¥à ÌéòÏù¥ÏßÄ)
		  -> gridInfo.gridNm			  : String - Î∂ÄÎ™® Ïª¥Ìè¨ÎÑåÌä∏ Ïù¥Î¶Ñ
		  -> gridInfo.rowCnt              : int  - Ìïú Ìå®Ïù¥ÏßÄÎãπ row ÌëúÌòÑ Í∞ØÏàò
		  -> gridInfo.gridKey             : String - Ìï¥Îãπ Í∑∏Î¶¨ÎìúÏùò Í≥†Ïú† ÌÇ§Í∞í (Ï†ïÎ†¨ ÏÇΩÏûÖ Îì±Ïóê ÏÇ¨Ïö©?)
		  -> gridInfo.isBtnGrp            : bool  - ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖòÏùòÍ≥ºÏùò Ïã±ÌÅ¨(ÎÇòÌÉÄÎÇòÎäî ÏµúÏ¥à ÌéòÏù¥ÏßÄ)
		  -> gridInfo.isResize            : bool  - Ïª¨Îüº ÎßàÏö∞Ïä§ ÎìúÎûòÍ∑∏Î°ú Î¶¨ÏÇ¨Ïù¥Ï¶à (Ï†ïÎ†¨Í≥º ÎèôÏãúÏÇ¨Ïö© Î∂àÍ∞Ä)
		  -> gridInfo.isNotSort           : bool  - Ï†ïÎ†¨ ÎπÑÌôúÏÑ±Ìôî
		  -> gridInfo.isUseBody           : bool  - ÏóëÏÖÄ ÏóÖÎ°úÎìú content
		  -> gridInfo.gridDense           : bool  - row Ìè≠ Ï¢ÅÍ≤å
		  -> gridInfo.isUseHeader         : bool  - ÏóëÏÖÄ ÏóÖÎ°úÎìú Î≥ÄÌôò Ìó§Îçî
		  -> gridInfo.isCheckBox          : bool - Ï≤´Î≤àÏß∏ columnÏóê checkbox ÏÇ¨Ïö©Ïú†Î¨¥
		  -> gridInfo.isFiltering         : boolean - ÌïÑÌÑ∞ÎßÅ Ìï† ÌÖçÏä§Ìä∏ ÌïÑÎìú Ï†ïÎ≥¥ ÏÉùÏÑ± Ïú†Î¨¥
		  -> gridInfo.isSingleSelect      : bool - trueÏùºÏãú Ï†ÑÏ≤¥ÏÑ†ÌÉù ÏóÜÏùå.
		  -> gridInfo.mobile-breakpoint   : String | int - Î™®Î∞îÏùº Î≤ÑÏ†ÑÏúºÎ°ú Ïñ∏Ï†ú Î≥¥Ïó¨ÏßàÏßÄ
		  -> gridInfo.hide_default_header : bool - ÌÖåÏù¥Î∏îÏùò ÎîîÌè¥Ìä∏ Ìó§Îçî ÏÇ¨Ïö©Ïú†Î¨¥
		  -> gridInfo.hide_default_footer : bool  - ÌÖåÏù¥Î∏îÏùò ÎîîÌè¥Ìä∏ Ìë∏ÌÑ∞ ÏÇ¨Ïö©Ïú†Î¨¥(ÌòÑÏû¨ ÌéòÏù¥ÏßÄ ÏúÑÏπò Î∞è Ï†ÑÏ≤¥ ÌéòÏù¥ÏßÄ Ï†ïÎ≥¥)

		  üîÖ Ìï®Ïàò
		  -> gridInfo.rowClick            : function - Î°úÏö∞ ÌÅ¥Î¶≠Ïãú Î∞õÏùÑ Ìï®Ïàò Î™Ö(clickÎêú rowÏ†ïÎ≥¥ÏôÄ gridÎ™Ö ÌååÎùºÎ©îÌÑ∞Î°ú ÎÑòÍ≤®Ï§å)
		  -> gridInfo.rowDBClick          : function - Î°úÏö∞ ÌÅ¥Î¶≠Ïãú Î∞õÏùÑ Ìï®Ïàò Î™Ö(clickÎêú rowÏ†ïÎ≥¥ÏôÄ gridÎ™Ö ÌååÎùºÎ©îÌÑ∞Î°ú ÎÑòÍ≤®Ï§å)
		  -> colEditList : Array(json)  { isEdit:true , obj : textBox} ,{ isEdit:true , obj : Btn , action:rowBtnClick(row , gridNm)}
-->
<template>
	<v-container fluid pa-0 ma-0 style="background-color: lightcoral; height: 100%;">
		<v-card class="mb-3 pa-0" outlined tile height="100%">
			<v-card-title>

			</v-card-title>

			<v-data-table 
				:dense="gridInfo.dense== undefined? true:gridInfo.dense" 
				v-model="selected"
				:headers="gridInfo.headers" 
				:items="gridDataList"
				:items-per-page="gridInfo.rowCnt == undefined? 5: gridInfo.rowCnt"
				
				:search="filteringTxt"
				:loading="false"
    			loading-text="Loading... Please wait"
				@page-count="pageCount = $event"
				:show-select="gridInfo.isCheckBox"
				:single-select="gridInfo.isSingleSelect" 
				:hide-default-header="false"
				:hide-default-footer="gridInfo.hide_default_footer" 
				:item-key="gridKey"
				:disable-sort="gridInfo.isNotSort==undefined?true:gridInfo.isNotSort" 
				multi-sort
				@click:row="fn_rowClick"
				@dblclick:row="fn_rowDbClick"
				
				:disable-pagination="true"
				fixed-header
				height="50vh"
				
				mobile-breakpoint="xs"
				>

				<template v-slot:top>
					<v-toolbar flat dense class="ma-0 pa-0">
						<v-toolbar-title>{{ gridInfo.gridNm }}</v-toolbar-title>
						<v-divider class="mx-4" inset vertical />
						<v-spacer />
						<div style="width: 250;">
							<v-text-field
								v-if="gridInfo.isFiltering"
								v-model="filteringTxt"
								append-icon="mdi-magnify"
								label="Grid Filtering"
								single-line hide-details
							></v-text-field>
						</div>
						<span>
							<v-btn outlined class="ml-3 mr-1" v-if="gridInfo.searchBtnClick" @click="fn_searchBtnClick">
								{{gridInfo.searchBtnNm==undefined?"Ï°∞Ìöå":gridInfo.searchBtnNm}}
							</v-btn>
							<v-btn outlined class="mr-1" v-if="gridInfo.addBtnClick" @click="fn_addBtnClick">
								{{gridInfo.addBtnNm==undefined?"Ï∂îÍ∞Ä":gridInfo.addBtnNm}}
							</v-btn>
							<v-btn outlined class="mr-1" v-if="gridInfo.delBtnClick" @click="fn_delBtnClick">
								{{gridInfo.delBtnNm==undefined?"ÏÇ≠Ï†ú":gridInfo.delBtnNm}}
							</v-btn>
							<v-btn outlined class="mr-1" v-if="gridInfo.moreBtnClick" @click="fn_moreBtnClick">
								{{gridInfo.moreBtnNm==undefined?"Ï†ÑÏ≤¥Î≥¥Í∏∞":gridInfo.moreBtnNm}}
							</v-btn>
							<v-btn outlined v-if="gridInfo.excelDownClick" @click="fn_excelDownClick">
								{{gridInfo.excelDownNm==undefined?"Excel Down":gridInfo.excelDownNm}}
							</v-btn>
						</span>
						
					</v-toolbar>
				</template>

	<!-- v-if="gridInfo.isCustomHeader" -->
				<template v-if="gridInfo.isUseHeader"
					v-slot:header="{ props: { headers } }"
				>
					<thead>
					<tr id='tableheaders' >
						<template v-for="header in headers" >
						<th :key="header.text">
							{{ header.text }}
						</th>
						</template>
					</tr>
					</thead>
				</template>

				<template  v-if="gridInfo.isUseBody" v-slot:body="{ items }">
					<tr v-for="item in items" :key="item.name">
					<td v-for="header in gridInfo.headers" :key="header.text" >
						{{ item[header.value]}} 
					</td>
					</tr>
				</template>
				<!-- <template v-slot:items="{ item }">
					<td v-for="header in gridInfo.headers" :key="header.value" style="background-color: red;">
						{{ item[header.value] }}
					</td>
				</template> -->
			</v-data-table>
			<template>
				<v-file-input
					v-if="gridInfo.excelUploadClick"
					class="ma-o pa-0"
					small-chips show-size outlined dense hide-details
					prepend-icon="mdi-paperclip"
					:label="gridInfo.excelUploadNm==undefined?'Excel Upload':gridInfo.excelUploadNm"
					accept="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
					@change="fn_excelUploadClick"
				/>
			</template>
			<!-- ÌéòÏù¥ÏßÄ ÎÑ§Ïù¥ÏÖò-->
			<!-- <template v-if="gridInfo.page">
				<v-pagination v-model="gridInfo.page" :length="pageCount" :total-visible="5" circle />
			</template> -->
		</v-card>
	</v-container>
</template>

<script>


var tables = document.getElementsByTagName('table');

function setNewPos(parentNode, oldIndex, oldNode, newIndex, newNode) {
  setTimeout(() => {
    if (oldIndex < newIndex) {
      parentNode.insertBefore(oldNode, newNode.nextSibling);
    } else {
      parentNode.insertBefore(oldNode, newNode);
    }
  }, 150);
}

// Add back the sortHandle class if it gets stripped away by external code
function watchClass(targetNode, classToWatch) {
  let lastClassState = targetNode.classList.contains(classToWatch);
  const observer = new MutationObserver((mutationsList) => {
    for (let i = 0; i < mutationsList.length; i++) {
      const mutation = mutationsList[i];
      if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
        const currentClassState = mutation.target.classList.contains(classToWatch);
        if (lastClassState !== currentClassState) {
          lastClassState = currentClassState;
          if (!currentClassState) {
            mutation.target.classList.add('sortHandle');
          }
        }
      }
    }
  });
  observer.observe(targetNode, { attributes: true });
}

function sortTableRows(el) {
  const options = {
    handle: '.sortHandle',
    animation: 150,
    onStart: (evt) => {
      // Flag all cells in the column being dragged by adding a class to them
      el.querySelectorAll('tr').forEach((row) => {
        const draggedTd = row.querySelectorAll('td')[evt.oldIndex];
        if (draggedTd) {
          draggedTd.classList.add('sorting');
        }
      });
    },
    onEnd: (evt) => {
      // Take the dragged cells and move them over to the new column location
      el.querySelectorAll('tr').forEach((row) => {
        if (!row.querySelector('th')) {
          const oldNode = row.querySelector('.sorting');
          const newNode = row.querySelectorAll('td')[evt.newIndex];
          setNewPos(row, evt.oldIndex, oldNode, evt.newIndex, newNode);
          oldNode.classList.remove('sorting');
        }
      });
    },
  };
  const initEl = el.getElementsByTagName('thead')[0].getElementsByTagName('tr')[0];
  return Sortable.create(initEl, options);
}




export default {
	props: ['gridInfo', "gridDataList"],
	data: () => ({
		pageCount: 0,
		selected: [],
		currentIndex : -1,
		filteringTxt:"", 
	}),
	methods: {
		/** grid click event */
		//row ÌÅ¥Î¶≠
		fn_rowClick(event, info) {
			this.currentIndex = info.index;
			if(this.gridInfo.rowClick)
				this.gridInfo.rowClick(event, info , this.gridInfo.gridNm);
		},
		//row ÎçîÎ∏îÌÅ¥Î¶≠
		fn_rowDbClick(event, info) {
			if(this.gridInfo.rowDbClick)
				this.gridInfo.rowDbClick(event, info, this.gridInfo.gridNm);
		},
		//Ï°∞ÌöåÎ≤ÑÌäº ÌÅ¥Î¶≠
		fn_searchBtnClick(){
			if(this.gridInfo.searchBtnClick)
				this.gridInfo.searchBtnClick(this.gridInfo.gridNm);
		},
		//Ï∂îÍ∞Ä Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
		fn_addBtnClick(){
			if(this.gridInfo.addBtnClick)
				this.gridInfo.addBtnClick(this.gridInfo.gridNm , this.currentIndex);
		},
		//ÏÇ≠Ï†ú Î≤ÑÌäº ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
		fn_delBtnClick(){
			if(this.gridInfo.delBtnClick)
				this.gridInfo.delBtnClick(this.gridInfo.gridNm , this.currentIndex);
		},
		//ÎçîÎ≥¥Í∏∞ Î≤ÑÌäº ÌÅ¥Î¶≠
		fn_moreBtnClick (){
			if(this.gridInfo.moreBtnClick)
				this.gridInfo.moreBtnClick(this.gridInfo.gridNm);
		},
		
		//excel down Î≤ÑÌäº ÌÅ¥Î¶≠
		fn_excelDownClick (){
			if(this.gridInfo.excelDownClick)
				this.gridInfo.excelDownClick(this.gridInfo.gridNm);
		},
		fn_excelUploadClick (file){
			if(this.gridInfo.excelUploadClick)
				this.gridInfo.excelUploadClick(this.gridInfo.gridNm , file);
		},

		//Ïª¨Îüº ÎßàÏö∞Ïä§ ÎìúÎ†àÍ∑∏ Î¶¨ÏÇ¨Ïù¥Ï¶à Ìï®Ïàò
		resizableGrid(table){
			console.log("1.resizableGrid start=================================");
			var row = table.getElementsByTagName('tr')[0],
				cols = row ? row.children : undefined;
			if (!cols) return;

			console.log("2.resizableGrid start=================================");

			table.style.overflow = 'hidden';

			var tableHeight = table.offsetHeight;

			for (var i = 0; i < cols.length; i++) {
				var div = createDiv(tableHeight);
				cols[i].appendChild(div);
				cols[i].style.position = 'relative';
				setListeners(div);
			}

			function setListeners(div) {

				console.log("1.setListeners start=================================");
				var pageX, curCol, nxtCol, curColWidth, nxtColWidth;

				div.addEventListener('mousedown', function (e) {
					curCol = e.target.parentElement;
					nxtCol = curCol.nextElementSibling;
					pageX = e.pageX;

					var padding = paddingDiff(curCol);

					curColWidth = curCol.offsetWidth - padding;
					if (nxtCol)
						nxtColWidth = nxtCol.offsetWidth - padding;
				});

				div.addEventListener('mouseover', function (e) {
					e.target.style.borderRight = '';//2px solid #0000ff
				})

				div.addEventListener('mouseout', function (e) { 
					e.target.style.borderRight = '';
				})

				document.addEventListener('mousemove', function (e) {
					if (curCol) {
						var diffX = e.pageX - pageX;

						if (nxtCol)
							nxtCol.style.width = (nxtColWidth - (diffX)) + 'px';

						curCol.style.width = (curColWidth + diffX) + 'px';
					}
				});

				document.addEventListener('mouseup', function (e) {
					curCol = undefined;
					nxtCol = undefined;
					pageX = undefined;
					nxtColWidth = undefined;
					curColWidth = undefined
				});
			}

			function createDiv(height) {
				var div = document.createElement('div');
				div.style.top = 0;
				div.style.right = 0;
				div.style.width = '5px';
				div.style.position = 'absolute';
				div.style.cursor = 'col-resize';
				div.style.userSelect = 'none';
				div.style.height = height + 'px';
				return div;
			}

			function paddingDiff(col) {

				if (getStyleVal(col, 'box-sizing') == 'border-box') {
					return 0;
				}

				var padLeft = getStyleVal(col, 'padding-left');
				var padRight = getStyleVal(col, 'padding-right');
				return (parseInt(padLeft) + parseInt(padRight));

			}

			function getStyleVal(elm, css) {
				return (window.getComputedStyle(elm, null).getPropertyValue(css))
			}
		},


		

	},

	directives: {
		'sortable-table': {
			componentUpdated: (el) => {
				sortTableRows(el);
			},
			bind: (el) => {
				el.querySelectorAll('th').forEach((draggableEl) => {
					// Need a class watcher because sorting v-data-table rows asc/desc removes the sortHandle class
					watchClass(draggableEl, 'sortHandle');
					draggableEl.classList.add('sortHandle');
				});
				sortTableRows(el);
			},
		},
	},

	computed: {
		gridKey() {
			let key = '';
			this.gridInfo.headers.forEach(x => {
				if (x.key != undefined && x.key !== '') {
					key = x.value;
				}
			});
			console.log('key = ' + key);
			return key;
		},

		filteredHeaders: {
            get: function() { return this.gridInfo.headers; },
            set: function( headers ){ return this.gridInfo.headers;}
        },

		//Ïä§ÌÅ¨Î°§
		items () {
        	return Array.from({ length: this.length }, (k, v) => v + 1)
		},
		length () {
			return 7000
		},
	},
	
	created(){
		// test();
		
	},
	mounted() {
		//Ïª¨Îüº ÎßàÏö∞Ïä§ ÎìúÎ†àÍ∑∏ Î¶¨ÏÇ¨Ïù¥Ï¶à Îì±Î°ù
		//Ï†ïÎ†¨Í∏∞Îä•Í≥º Í∞ôÏù¥ ÏÇ¨Ïö©ÌïòÎ©¥ ÏïàÎê®.
		if(this.gridInfo.isResize){
			for (var i=0; i<tables.length;i++){
				this.resizableGrid(tables[i]);
			}
		}
		

	},
};





</script>

<style>
th, td {
  border-right: 1px solid grey;
}
.app {
  background: lightgrey !important;
  height: 100vh;
  overflow: hidden;
}

.view {
  display: flex;
  flex-direction: column;
  height: 100%;
  padding: 20px;
}

.card-top {
  padding: 20px;
}

.table-container {
  display: flex;
  margin-top: 20px;
  flex-grow: 1;
  overflow: hidden;
}

.flex-table {
  display: flex;
  flex-grow: 1;
  width: 100%;
}

.flex-table > div {
  width: 100%;
}

.v-btn:not(.v-btn--round).v-size--default:not(:last-child){
	height: 36px;
    min-width: 64px;
    padding: 0 0px;
}


</style>
